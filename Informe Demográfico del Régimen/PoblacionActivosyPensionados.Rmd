
# Pensionados

```{r}
library(readxl)

# Leer la hoja 'Pensionados'
pensionados <- read_excel("Fondo C.xlsx", sheet = "Pensionados")
pensionados <- subset(pensionados, select = -c(1, 3, 6, 7, 9, 10, 11))

# Leer la hoja 'Activos'
activos <- read_excel("Fondo C.xlsx", sheet = "Activos")
activos <- activos[, -c(1, (ncol(activos)-1):ncol(activos))]
```

```{r}
# Calcular la edad al 31 de diciembre de 2023
pensionados$FEC_NAC <- as.Date(pensionados$FEC_NAC) # Asegurar que FEC_NAC es de tipo Date
pensionados$Edad <- as.numeric(format(as.Date("2023-12-31"), "%Y")) - as.numeric(format(pensionados$FEC_NAC, "%Y"))
```

```{r}
pensionados$Edad_intervalo <- cut(pensionados$Edad, breaks = seq(0, 85, by = 5), include.lowest = TRUE)

# Contar la cantidad de hombres y mujeres en cada intervalo de edad
piramide <- pensionados %>%
  group_by(Edad_intervalo, SEXO, COD_TIPO_PENSION) %>%
  summarise(Count = n(), .groups = "drop") %>%
  ungroup()

# Graficar la pirámide poblacional
ggplot(piramide, aes(x = Edad_intervalo, y = ifelse(SEXO == "M", -Count, Count), fill = SEXO)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs) +
  labs(title = "Pirámide Poblacional de Pensionados",
       subtitle = "2023",
       x = "Edad",
       y = "Pensionados",
       fill = "Sexo") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0, color = "black", size = 8),
        legend.title = element_blank()) +
  coord_flip()+
  scale_fill_manual(values = c( "cadetblue3","#2F4F4F"),
                    labels = c( "Mujeres","Hombres"))+
  labs(caption = expression(bold("Fuente: ") * "Elaboración propia a partir de datos del fondo de pensiones."))
```


```{r}
pensionados_por_tipo <- pensionados %>%
  group_by(COD_TIPO_PENSION, SEXO) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = SEXO, values_from = Count, values_fill = 0)

datos_long2 <- tidyr::pivot_longer(pensionados_por_tipo, cols = c(F, M), names_to = "Sexo", values_to = "Cantidad")

ggplot(datos_long2, aes(x = COD_TIPO_PENSION, y = Cantidad, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Distribución de los Tipos de Pension",
       subtitle = "2023",
       x = "Tipos de Pensión",
       y = "Cantidad",
       fill = "Género") +
  scale_fill_manual(values = c("cadetblue3", "#2F4F4F"), labels = c("Mujeres", "Hombres")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0, color = "black", size = 8),
        legend.title = element_blank())+
  labs(caption = expression(bold("Fuente: ") * "Elaboración propia a partir de datos del fondo de pensiones."))
```



```{r}
pensionados <- pensionados %>%
  mutate(Edad_Pension = as.numeric(difftime(`Rige de la Pensión`, FEC_NAC, units = "days")) / 365.25) #calcula edad de pension

```

```{r}
#calcula el promedio de edad de pension por tipo y sexo
promedio_edad_pension_tipo<- pensionados %>%
  group_by(COD_TIPO_PENSION, SEXO) %>%
  summarize(promedio_edad_pension = mean(Edad_Pension, na.rm = TRUE)) 
```

```{r}
pensionados_na <- pensionados %>%
  filter(is.na(`Rige de la Pensión`)) 

# se le agrega la edad de pensión promedio a los que tienen NA's
pensionados_na_con_promedio <- left_join(pensionados_na, promedio_edad_pension_tipo, by = c("SEXO", "COD_TIPO_PENSION"))

# Actualiza la columna 'Edad_Pension' con el promedio de edad de pensión correspondiente
pensionados_na_con_promedio <- pensionados_na_con_promedio %>%
  mutate(Edad_Pension = ifelse(is.na(Edad_Pension), promedio_edad_pension, Edad_Pension))

# Eliminar la columna 'promedio_edad_pension'
pensionados_na_con_promedio <- pensionados_na_con_promedio[, -8]

# pone la fecha en que se pensionarían
pensionados_na_con_promedio <- pensionados_na_con_promedio %>%
  mutate(`Rige de la Pensión` = 
    fecha_pension <- FEC_NAC + as.numeric(Edad_Pension) * 365.25 * 24 * 60 * 60)

fecha_inicio_pension <- pensionados_na_con_promedio$`Rige de la Pensión`
for(i in 1 : length(fecha_inicio_pension)) {
  if(year(fecha_inicio_pension[i]) > 2023){
    year(fecha_inicio_pension[i]) <- 2023
  }
}
pensionados_na_con_promedio$`Rige de la Pensión` <- fecha_inicio_pension

```



```{r}
promedio_edad_pension_sexo <- pensionados %>%
  group_by(SEXO) %>%
  summarize(promedio_edad_pension = mean(Edad_Pension, na.rm = TRUE)) #calcula el promedio de edad de pension

```

```{r}
pensionados <- pensionados %>%
  left_join(promedio_edad_pension_sexo, by = "SEXO") %>%
  mutate(Edad_Pension = ifelse(is.na(Edad_Pension), promedio_edad_pension, Edad_Pension)) %>%  
  select(-promedio_edad_pension)#asigna la edad de pensión según el sexo
```


```{r}
pensionados_na <- pensionados %>%
  filter(is.na(`Rige de la Pensión`)) #aquí trabaja solo con los que tiene NA's

```

```{r}
pensionados_na <- pensionados_na %>%
  mutate(`Rige de la Pensión` = FEC_NAC + as.numeric(Edad_Pension) * 365.25 * 24 * 60 * 60)  #pone la fehca en que se pensionarían

```

```{r}
pensionados <- bind_rows(pensionados_na, pensionados %>% filter(!is.na(`Rige de la Pensión`))) #une todo
```

```{r}
pensionados <- pensionados %>%
  mutate(Antiguedad_Pension = as.numeric(difftime(Sys.Date(), `Rige de la Pensión`, units = "days")) / 365.25) #calcula la antiguedad
```


```{r}
pensionados$Antiguedad_intervalo <- cut(pensionados$Antiguedad_Pension, 
                                        breaks = c(0, 1, 5, 10, 20, Inf),
                                        labels = c("<1", "1-5", "5-10", "10-20", "20<"),
                                        right = FALSE)
```

```{r}
pensionados_combined <- pensionados %>%
  group_by(Antiguedad_intervalo, SEXO) %>%
  summarise(Count = n(), .groups = "drop") %>%
  pivot_wider(names_from = SEXO, values_from = Count) %>%
  mutate(M = ifelse(is.na(M), 0, M), F = ifelse(is.na(F), 0, F))

datos_long <- tidyr::pivot_longer(pensionados_combined, cols = c(F, M), names_to = "Sexo", values_to = "Cantidad")

# Crear el gráfico
ggplot(datos_long, aes(x = Antiguedad_intervalo, y = Cantidad, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Distribución de la Antigüedad de Pensionados",
       subtitle = "2023",
       x = "Antigüedad (años)",
       y = "Cantidad",
       fill = "Género") +
  scale_fill_manual(values = c("cadetblue3", "#2F4F4F"), labels = c("Mujeres", "Hombres")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0, color = "black", size = 8),
        legend.title = element_blank())+
  labs(caption = expression(bold("Fuente: ") * "Elaboración propia a partir de datos del fondo de pensiones."))
```






# ACTIVOS

Al 31 de diciembre de 2023 hay un total de 3.758 de cotizantes activos del fondo de pensiones, cuya distribución por sexo es la siguiente: 1.907 mujeres (50,75%) y 1.851 hombres (49,25%). 

```{r}
activos_filtrados <- activos %>%
  filter(rowSums(select(., -c(1:350))) != 0)
```


```{r}

activos_filtrados$Fec.Nac <- as.Date(activos_filtrados$Fec.Nac) # Asegurar que FEC_NAC es de tipo Date
activos_filtrados$Edad <- as.numeric(format(as.Date("2023-12-31"), "%Y")) - as.numeric(format(activos_filtrados$Fec.Nac, "%Y"))

```

```{r}
activos_filtrados$Edad_intervalo <- cut(activos_filtrados$Edad, breaks = seq(0, 80, by = 5), include.lowest = TRUE)

# Contar la cantidad de hombres y mujeres en cada intervalo de edad
piramide2 <- activos_filtrados %>%
  group_by(Edad_intervalo, Sexo) %>%
  summarise(Count = n(), .groups = "drop") %>%
  ungroup()

# Graficar la pirámide poblacional
ggplot(piramide2, aes(x = Edad_intervalo, y = ifelse(Sexo == "M", -Count, Count), fill = Sexo)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs) +
  labs(title = "Pirámide Poblacional de Activos",
       subtitle = "2023",
       x = "Edad",
       y = "Activos",
       fill = "Sexo") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0, color = "black", size = 8),
        legend.title = element_blank()) +
  coord_flip()+
  scale_fill_manual(values = c( "cadetblue3","#2F4F4F"),
                    labels = c( "Mujeres","Hombres"))+
  labs(caption = expression(bold("Fuente: ") * "Elaboración propia a partir de datos del fondo de pensiones."))
```

De acuerdo con los datos proporcionados, los cotizantes abarcan un rango de edades entre los 20 y los 78 años, con una edad promedio de 43.07 años. El gráfico muestra la distribución por edad y sexo de los cotizantes activos, destacándose una notable concentración entre los 40 y 50 años en ambos géneros.


```{r}

cotizaciones <- activos_filtrados[, -c(1:2, 363, 364)]

activos_filtrados$Antiguedad <- apply(cotizaciones[, 1:360] != 0, 1, function(x) {
  # Encuentra el índice del primer mes no cero
  primer_mes <- min(which(x))
  # Calcula la antigüedad (número de meses con cotizaciones)
  antiguedad <- 361 - primer_mes
  return(antiguedad)
})

activos_filtrados$Antiguedad <- activos_filtrados$Antiguedad / 12
```


```{r}
activos_filtrados$Antiguedad_Interva <- cut(activos_filtrados$Antiguedad, 
                                        breaks = c(0, 1, 5, 10, 20, Inf),
                                        labels = c("<1", "1-5", "5-10", "10-20", "20<"),
                                        right = FALSE)
```

```{r}
activos_combined <- activos_filtrados %>%
  group_by(Antiguedad_Interva, Sexo) %>%
  summarise(Count = n(), .groups = "drop") %>%
  pivot_wider(names_from = Sexo, values_from = Count) %>%
  mutate(M = ifelse(is.na(M), 0, M), F = ifelse(is.na(F), 0, F))

datos_long <- tidyr::pivot_longer(activos_combined, cols = c(F, M), names_to = "Sexo", values_to = "Cantidad")

# Crear el gráfico
ggplot(datos_long, aes(x = Antiguedad_Interva, y = Cantidad, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Distribución de la Antigüedad de Activos",
       subtitle = "2023",
       x = "Antigüedad (años)",
       y = "Cantidad",
       fill = "Género") +
  scale_fill_manual(values = c("cadetblue3", "#2F4F4F"), labels = c("Mujeres", "Hombres")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0, color = "black", size = 8),
        legend.title = element_blank())+
  labs(caption = expression(bold("Fuente: ") * "Elaboración propia a partir de datos del fondo de pensiones."))
```

En cuanto a la antigüedad, la media se sitúa en 12.54 años. En el gráfico se representa la distribución por rango de edad y sexo, evidenciando un grupo notablemente longevo de cotizantes en ambos géneros. La mayoría de ellos tienen entre 10 y 20 años de antigüedad, seguidos por aquellos con 5 a 10 años, y los que superan los 20 años de antigüedad.
